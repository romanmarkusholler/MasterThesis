// Rescue-Prime definition according to https://eprint.iacr.org/2020/1143
// Taken and adapted from https://github.com/novifinancial/winterfell/blob/main/examples/src/rescue/rescue.rs
// Parameters derived using https://github.com/KULeuven-COSIC/Marvellous

// Parameters
//   p   .. 340282366920938463463374557953744961537 (prime from winterfell::math::fields::f128)
//   m   .. 17
//   c_p .. 1
//   security at least 128 bit

use winterfell::math::{fields::f128::BaseElement, FieldElement};

pub type Elem = BaseElement;

// RESCUE CONSTANTS
// ================================================================================================

pub const NUM_ROUNDS: usize = 8;
pub const STATE_WIDTH: usize = 17;
pub const CAPACITY: usize = 1;
pub const RATE: usize = STATE_WIDTH - CAPACITY;
const ALPHA: u32 = 3;
const INV_ALPHA: u128 = 226854911280625642308916371969163307691;

const MDS: [Elem; STATE_WIDTH * STATE_WIDTH] = [
    Elem::new(105718987987774116708280237266411774293),
    Elem::new(103074774991905603397840394938412189006),
    Elem::new(91807806145926529007121874762154405937),
    Elem::new(283069247958837659789523993335873854892),
    Elem::new(333271869893260344465182408444195386832),
    Elem::new(68742759491884828035830427986845631668),
    Elem::new(177557846759161876294264013006391407802),
    Elem::new(121822028957565082394092780024871216637),
    Elem::new(264758063845471471892158984059046180360),
    Elem::new(322296929179970595786157707468139900895),
    Elem::new(280114365125493531615831345485655796106),
    Elem::new(229737428398004236809063128463106568571),
    Elem::new(4459719670583523048543100205187036),
    Elem::new(340282366912581242811453239073465558821),
    Elem::new(5177148428538944007480),
    Elem::new(340282366920938463463373515629921017417),
    Elem::new(64570081),
    Elem::new(195330279064111344245223980705265277905),
    Elem::new(271609732277061993836585905669925205238),
    Elem::new(246291362758010525909964078729012621271),
    Elem::new(146262208336700145480550674216245789046),
    Elem::new(26950463224865104042086511241130201851),
    Elem::new(339376875897680570231966023730924991986),
    Elem::new(101155906064000986185255787270410007885),
    Elem::new(65513421359192546555944829344672061483),
    Elem::new(174880229784571438745504770059605105890),
    Elem::new(199348961134279518107116044024035186550),
    Elem::new(16271728631096873496812673752435259775),
    Elem::new(284205186128360779058110391983866457290),
    Elem::new(315315380155464656589099339638403778185),
    Elem::new(339747200226179614620696630717946408577),
    Elem::new(325931672727861007337168803164),
    Elem::new(340282366920938401337589246191121095297),
    Elem::new(3126971536402441),
    Elem::new(23106645035994644321403335977828391486),
    Elem::new(128112231392765531348196121464121750638),
    Elem::new(213517568196184588483305058830192149958),
    Elem::new(44681949715081330505294885619540684169),
    Elem::new(299835461142354743406619257452258076406),
    Elem::new(326524035645101197921001725820339567239),
    Elem::new(80700907323683459581734691909546835275),
    Elem::new(11623581960248107326148795618632320067),
    Elem::new(24063810451468614121508851652028884139),
    Elem::new(6171635060763315332317298478163295693),
    Elem::new(339904414638726369844078741015689048055),
    Elem::new(189295196109343120892980632066106449043),
    Elem::new(149357323855731158031734755849502798192),
    Elem::new(189145814850556660413515001775330505418),
    Elem::new(15653629081013055926939445018795705720),
    Elem::new(340282363987553207003823228690698167781),
    Elem::new(139783020078437440101481),
    Elem::new(266655855503702688583521320766378799257),
    Elem::new(107532977059558543347481046263256455694),
    Elem::new(116015198875402366746618000591249872307),
    Elem::new(293657634284454868046901595449979023637),
    Elem::new(270018751618102183132683143406642671145),
    Elem::new(264626227454797418037126270522720588637),
    Elem::new(335745399395508210669646493537489771924),
    Elem::new(211714644757782392976267315574239212298),
    Elem::new(11622258068123307527547035315466431143),
    Elem::new(124525164825763680198075704344714016952),
    Elem::new(231243304129648857128226906757168452350),
    Elem::new(302132384956471943247736025877835439896),
    Elem::new(218478089282565507155424476098269817629),
    Elem::new(295621283079889144336994171512854310751),
    Elem::new(142997665833860949028765078854887730009),
    Elem::new(210236823991336902040950463142067425537),
    Elem::new(6092415672429780531522229596205),
    Elem::new(328931255514928851806398662023726523252),
    Elem::new(178677795762332424384555828563248609463),
    Elem::new(74504656388106085868671788295675022982),
    Elem::new(3355920091272438799704681744064068279),
    Elem::new(224156911319273231263096406196768129450),
    Elem::new(68921736138339841371099930741097522239),
    Elem::new(18563062305621461001454693730615510918),
    Elem::new(232999119116161488136347640446933387061),
    Elem::new(17854553961496621291097383605733512231),
    Elem::new(91471126042840664796533259156768367053),
    Elem::new(281330192064596874813784877999825216490),
    Elem::new(114533900193234715750527785204672995892),
    Elem::new(99862712549867856617764273300164030973),
    Elem::new(87680844689934459711742438259463841165),
    Elem::new(248132287871611026478622536038895226956),
    Elem::new(47658263912092367842030396852686159751),
    Elem::new(263342230524858834310189323515876606605),
    Elem::new(59268532223222188074151510451465284940),
    Elem::new(43530286889899643390803289317155053803),
    Elem::new(87979654358958320269090142586299356658),
    Elem::new(157797696484774780870095656658103317607),
    Elem::new(305135696958671762423596405448776034535),
    Elem::new(108503868478515746185736892194852928177),
    Elem::new(302811204718506750979888347882211150261),
    Elem::new(303950972057244819965713505773554401454),
    Elem::new(300783319237607089272929022966577940285),
    Elem::new(43620832297052934465942769053148784496),
    Elem::new(319620720231471445399917646095122234520),
    Elem::new(211445838243238068293694917717803457370),
    Elem::new(192454524967361452007863568698902672646),
    Elem::new(108639068748012874181081046171976936102),
    Elem::new(73197884675770641658389879511382166684),
    Elem::new(214299847708797820986734586467937217490),
    Elem::new(229501354009339832744741834588435716806),
    Elem::new(333316882056940591127374937137064838440),
    Elem::new(144066626309251740408306404138290746026),
    Elem::new(10467332144592535097061933627767620457),
    Elem::new(236869100440383163290986898130939906162),
    Elem::new(226500649718587517673915305613154086397),
    Elem::new(60478183246165619339694533679134472129),
    Elem::new(260846644241822064957639809916641768210),
    Elem::new(224679469151205967599147570120966048655),
    Elem::new(207426184070524691682225383610540121070),
    Elem::new(66215323384014961530731242521123673138),
    Elem::new(172220097072272852719172974960453518287),
    Elem::new(295392777941704250712743989231119160561),
    Elem::new(321925045560560908890350975499453480330),
    Elem::new(310127669541798932342328610004290268054),
    Elem::new(259808232066505011272694592827850256478),
    Elem::new(107582279244229407389170990340019803816),
    Elem::new(164901173018824418600199428178639847161),
    Elem::new(277707874222273814396914821644915972063),
    Elem::new(129454567561412678135562411976301233361),
    Elem::new(34905161026843799176278553787928097076),
    Elem::new(57311748132345437415562084377025122661),
    Elem::new(289601265389907135917507348164847672179),
    Elem::new(59119660856176146084733908500776709432),
    Elem::new(210616184740322978466149434994151645650),
    Elem::new(197563143894841478706342889008181601668),
    Elem::new(103285697068333531050555728032172790745),
    Elem::new(263925024391967285669142543411441973893),
    Elem::new(301999966811417669287617246799838247869),
    Elem::new(57003411570203495441904869818532247954),
    Elem::new(257144991159184999607050612812298602092),
    Elem::new(54480131528402195492183237060291051924),
    Elem::new(93442576131104995743842874296451101350),
    Elem::new(93966926606902876897755647515362272848),
    Elem::new(240730604275867190217892251429443349532),
    Elem::new(274529876817885684659256675971482785763),
    Elem::new(240878503524933587866224396179199003924),
    Elem::new(220894620835334619558290171080441198535),
    Elem::new(324468944843809469632849824161199810525),
    Elem::new(45004469489030504450774500972574903705),
    Elem::new(108755006576686169803520790006203932939),
    Elem::new(182639479146553252090056014204341653497),
    Elem::new(67656226905106163059261630941732432217),
    Elem::new(50004100500934015346759910148586781508),
    Elem::new(144695983281761789137300504777478090871),
    Elem::new(14756013802889867660591691134733543303),
    Elem::new(70358717430853238270776891702673827557),
    Elem::new(337406288528040123903071392591438348479),
    Elem::new(180909970359872471609969317181537390056),
    Elem::new(170944107196892871130754725969562916989),
    Elem::new(311944566827184885783797750178015138704),
    Elem::new(316694426220677457207114834382502895262),
    Elem::new(98756381281049513820736021294310303956),
    Elem::new(177946525525901928809042223250022540404),
    Elem::new(196459562567267402813776045905725717522),
    Elem::new(68653742108103806598604000371040229273),
    Elem::new(72603841754457388330747881673966230761),
    Elem::new(225129221315140075035066887194516071929),
    Elem::new(95784261282372666075349407606978670993),
    Elem::new(1541270035569705972198973428554866123),
    Elem::new(299245265636733336433506054420283275531),
    Elem::new(97476598452595043445994302872584927206),
    Elem::new(309650334818339714695747772462937249197),
    Elem::new(103678869188694082592524498617843266328),
    Elem::new(206891264602297002478402756912383024962),
    Elem::new(122772604902488067596906824415540752619),
    Elem::new(313079471986110129269243619969761057525),
    Elem::new(311947270695618484928820616165962606184),
    Elem::new(20642449214769358810328577067548901784),
    Elem::new(22976672261247419486459896178605058810),
    Elem::new(92306792441674623180443113159550527547),
    Elem::new(235245607175391069749815572028978056955),
    Elem::new(26817386367468498807737174567575411230),
    Elem::new(163830534891371239570330287881730616224),
    Elem::new(259856395022580679272221614450202710424),
    Elem::new(265924017579917109974956844318455142828),
    Elem::new(182911931082981262302665671453471253561),
    Elem::new(194116636917004049704904427659839930852),
    Elem::new(149068459112880526485296627392341963427),
    Elem::new(78737700316094004239801962834004501572),
    Elem::new(124409832153457759953683648762461061218),
    Elem::new(184732683327107058401040803152164740684),
    Elem::new(263578261424573506163354201202919297236),
    Elem::new(296257054282840982830240689884399456859),
    Elem::new(262087871619169100550738082630748976571),
    Elem::new(259683466312687280496680404026255947836),
    Elem::new(29587336140283482819221083742256258315),
    Elem::new(52413753172488262095744535531534663980),
    Elem::new(28002834233455832531844084313484269505),
    Elem::new(123904555483347359983466125673725247862),
    Elem::new(278741279507382069333105409128828205253),
    Elem::new(10877997087968697699136005271705452780),
    Elem::new(235868388102552321511826933713696435648),
    Elem::new(163600632126197568049749506083078821012),
    Elem::new(150923641163824169871607989049481080254),
    Elem::new(177576766964579082054792337078397978016),
    Elem::new(204043391243960565120341329215697198937),
    Elem::new(118683665229565884193411926120355861059),
    Elem::new(161069713591313002658281413952667575726),
    Elem::new(309892073423354410942909293829567065201),
    Elem::new(309288855810554827950014183751482912676),
    Elem::new(147640176522622872062909756704023375894),
    Elem::new(220143875564057298828634550469977290179),
    Elem::new(142320071697396045197757192640439487761),
    Elem::new(94324440505012394270567396018292954106),
    Elem::new(54917562329301678784438984453177182629),
    Elem::new(167789519778820542685511460946281201182),
    Elem::new(155393888561312216777274150035249699674),
    Elem::new(114600042891991949495594803270433742564),
    Elem::new(157660275157045426387564908921196685921),
    Elem::new(108593577136902764668785704557381826271),
    Elem::new(233123385921938016837407142887641115307),
    Elem::new(241001517796635383190780973278844048688),
    Elem::new(58894260198471694057923185236884182756),
    Elem::new(230479595787971242858369942583541362874),
    Elem::new(200250383125956212815365878147740841415),
    Elem::new(283372941906168349489099446540608361234),
    Elem::new(81932879955735516767099624224411864301),
    Elem::new(243331480549736870764582443185707864285),
    Elem::new(154273112067111402658873226702127271329),
    Elem::new(97192184831609778365388153209837639091),
    Elem::new(37257733346390891711930371313554402957),
    Elem::new(6631212364277181467186537637408069572),
    Elem::new(67752098024907850954232240901860260516),
    Elem::new(3567194388406524077111107590448314409),
    Elem::new(123875801339212741149140454723091026664),
    Elem::new(163257720635311345362777250927821871037),
    Elem::new(235077851293400368107157768659846220599),
    Elem::new(40207506509738452859205388434095933270),
    Elem::new(287487706391953361147943054646770517164),
    Elem::new(34386878764098125343122813870606707145),
    Elem::new(160392901836820426969636071125874519026),
    Elem::new(67790328990483056178953357810200141958),
    Elem::new(86055634450277550777746883703520836897),
    Elem::new(268310951529329164066985881284159241871),
    Elem::new(147196575837150712523296009734657679261),
    Elem::new(215253920992263249718434002148716387786),
    Elem::new(217030991078294005635672116258270144171),
    Elem::new(99378430806218139742787318758890145595),
    Elem::new(9268863212766603140359488474122561963),
    Elem::new(83160825604949191474057790765524938032),
    Elem::new(160806417239142830265358659705910270001),
    Elem::new(81707918610512329561602204714606208598),
    Elem::new(221581362370600201447419578505005920026),
    Elem::new(228396314040672689316120252012943428175),
    Elem::new(310507695218182532063120217244756612001),
    Elem::new(102951940914617397932628228348049064358),
    Elem::new(290152054226470909684316097172005904366),
    Elem::new(239136137141064276954193225009594592252),
    Elem::new(285887055831275234185859172120749146349),
    Elem::new(58193900019903005362771628892143613212),
    Elem::new(103800622520677906653387991876371317894),
    Elem::new(233813687626021807880851544115542787511),
    Elem::new(336767085827077109869865507609217999330),
    Elem::new(141947631893369582640924059608740158960),
    Elem::new(61793775817266060324480189813485562436),
    Elem::new(257732829820123971505097903634322129312),
    Elem::new(205101865559360627847976779753054209020),
    Elem::new(202345131278315442433286710753965312374),
    Elem::new(29118454197574268244051309154296014198),
    Elem::new(191500077378551298447846504504972228622),
    Elem::new(94260308707786944432247765914554281803),
    Elem::new(223992113015209730096131886888327932243),
    Elem::new(84898200948245502173399238928392343263),
    Elem::new(334929026146860841058558090595677526307),
    Elem::new(98399216738807705703062322397636470128),
    Elem::new(197119376262780560620139585776018543613),
    Elem::new(17249011184995714461376637653307889142),
    Elem::new(289165583715076444125680015164274649726),
    Elem::new(93830098488795116801727636790637941926),
    Elem::new(198876234214387896791009826298296499224),
    Elem::new(224322874713050003798446964543874058279),
    Elem::new(104262551809975028645597084542497288495),
    Elem::new(75316872551556582918722625760952066084),
    Elem::new(184809753629010240955686779677308210742),
    Elem::new(145246387279162555370634182654173251802),
    Elem::new(93083180528111429211648836479099836963),
    Elem::new(222467801308251899641180993159634374879),
    Elem::new(49153565676415928406216530757998325672),
    Elem::new(296403256041173070253585086540872878764),
    Elem::new(310626725448917211626611623059655704249),
    Elem::new(4307917733783670792890556903100452896),
    Elem::new(25432956523343705342297458582738605497),
    Elem::new(82613578406941760400802576350354728798),
    Elem::new(147994573399768687508783547641070803807),
    Elem::new(189595676198532626744423502104022831124),
    Elem::new(62368185807713953911830222882845290930),
    Elem::new(163970711390860888714263334036016021779),
];

const INV_MDS: [Elem; STATE_WIDTH * STATE_WIDTH] = [
    Elem::new(183745484515705050831556552326499088299),
    Elem::new(141103678703214636197563513389143039257),
    Elem::new(163565696831753252710087586310309236434),
    Elem::new(62985313465011565676837944483152246967),
    Elem::new(114658452299969323545217916013090498206),
    Elem::new(147824456908078987741375446588010181152),
    Elem::new(176729300233670107895515391218786162224),
    Elem::new(228205546673028715233428987233813487439),
    Elem::new(159353636285759515650541284695649859325),
    Elem::new(175947905755654831667593389318646548552),
    Elem::new(315248562034624706259750220568618558246),
    Elem::new(221440431826445332911074199031247191812),
    Elem::new(301723768437184238604278948377563961586),
    Elem::new(19237575973549743752813783119860953554),
    Elem::new(238025875323249551837094265180902769652),
    Elem::new(174809344577903317608953683780061989270),
    Elem::new(237936272443643293046687909948348881859),
    Elem::new(251884657011757266275403024182685614637),
    Elem::new(177367297816836300466500712641422125844),
    Elem::new(219978398903361396433997564063936890321),
    Elem::new(80774198253705106986601120016019312320),
    Elem::new(269678447445874698258020039565846509249),
    Elem::new(204537510960676353918059432598693959648),
    Elem::new(58477807240852414557546853207795121652),
    Elem::new(313393234354154044989425402357152930135),
    Elem::new(147595581603211780846762953102610631035),
    Elem::new(169583210473916000063995248108394709238),
    Elem::new(328963123339005486912695373745324489602),
    Elem::new(269059513084468001547765518196682692661),
    Elem::new(77157822666349293829429205560428344379),
    Elem::new(26548545654319974586316982786013456935),
    Elem::new(225623922854525765938176670638619527454),
    Elem::new(116022071157121756966236817997747685821),
    Elem::new(125895959468310528593438102814330652903),
    Elem::new(29160439454871054305894263596783672292),
    Elem::new(149364923147424559069628730103588596603),
    Elem::new(294400574068127357416857313063059148641),
    Elem::new(245616961767576089225425467249647668481),
    Elem::new(272908204081166810845916800565832770159),
    Elem::new(311541231068723489959952767492370326230),
    Elem::new(205434943298397473136599338650695255505),
    Elem::new(37721317733366722283448142170733351638),
    Elem::new(79497165477994102874084920202907116889),
    Elem::new(312145126480836070748902785187877094045),
    Elem::new(46588710795029692107734146808211089006),
    Elem::new(234567237780442722195694805161635585000),
    Elem::new(73787573137468208639749511088667368146),
    Elem::new(292814439058048675084028633771301328994),
    Elem::new(46624238988634773605350880559797311494),
    Elem::new(325942129157139580652226250556195005365),
    Elem::new(104426086793198789018876265354401965346),
    Elem::new(275936287400940012624708814355463152239),
    Elem::new(147253166686333057523901207413521818395),
    Elem::new(52923531048539798806231919244419771941),
    Elem::new(88760537159405258201297361959171534407),
    Elem::new(259708594509849573531070287865446942886),
    Elem::new(60621974766085179255060125491720225015),
    Elem::new(109530163160209595172345325998749544170),
    Elem::new(229910050083567015598794192498489851959),
    Elem::new(296461688096315497645014432124159796386),
    Elem::new(100877728984774263921945326565495631242),
    Elem::new(334396990376428898153429943176108374666),
    Elem::new(143789382705249484884182942373106821361),
    Elem::new(201581993404336701004841307372525660487),
    Elem::new(237845859953263715771399032627850722620),
    Elem::new(189922333185894494486300124063400253602),
    Elem::new(52683523619452196930052179316467827074),
    Elem::new(280337497147801427659796499137606725384),
    Elem::new(119963645770044969599426637809721769934),
    Elem::new(40092879661561562540281785561329258827),
    Elem::new(12762443927970384790186608861200358697),
    Elem::new(4661348234480738005114026211506293446),
    Elem::new(77752496921324273721676748581177847364),
    Elem::new(137178250026536489377823436726657191069),
    Elem::new(243462948558145667890500240150261977107),
    Elem::new(216519946589880458106829045520064044095),
    Elem::new(67509614546378077629881704350534555968),
    Elem::new(241510170263567809436935157784452174997),
    Elem::new(272513668095100404256578818113109585411),
    Elem::new(206046454896122922311285747598505266953),
    Elem::new(31707359669632859506621242714254649567),
    Elem::new(220676653867701518770857537803133517279),
    Elem::new(173144604882431192358786373005202033364),
    Elem::new(132194710424217607583054935580761804253),
    Elem::new(184279372111472308357781859304342402429),
    Elem::new(93207669018061238817933660807420349764),
    Elem::new(104330993072060109375745386134086421960),
    Elem::new(149770447850562806885200024500603269675),
    Elem::new(90921844323998770555280132646036718839),
    Elem::new(259302798710278392210083281686434340882),
    Elem::new(286692366700969633737072614902585494008),
    Elem::new(255163561301688321594387899676543856879),
    Elem::new(307154248925193172679450706381899395507),
    Elem::new(200302800404721038089227159499857169266),
    Elem::new(218800558221818202205812383734331882546),
    Elem::new(40526113331041012137218501013094949050),
    Elem::new(176309195201707270171796211584864220048),
    Elem::new(448464029972800081132204758898169669),
    Elem::new(315027369922499670715259490445562255583),
    Elem::new(250220397897933296660390102695583141641),
    Elem::new(115095653077021588024318686914478673003),
    Elem::new(199266820298918847230062574201424345514),
    Elem::new(283979221988982651678429236652764801654),
    Elem::new(102366034984940202579394237649236553557),
    Elem::new(146755388677991083555543698630741511687),
    Elem::new(95175422746791843700259537180685066604),
    Elem::new(332628323258727457837887584075157866446),
    Elem::new(172841078958298928810329555538587653427),
    Elem::new(50314544179084238176278903032276910047),
    Elem::new(7307395555681414467178082497014493224),
    Elem::new(110135311179300766101703824293530982434),
    Elem::new(108221644374566973357574138917055358067),
    Elem::new(8887576944397409247679930389244984214),
    Elem::new(140049509643763918050627115204426308281),
    Elem::new(85656828456236264530020435645779057532),
    Elem::new(76930886485795324467133905160855245117),
    Elem::new(219259580902239068271063471300133487836),
    Elem::new(108740263168047305985649061968391163042),
    Elem::new(332727556941724393426869187540333287591),
    Elem::new(234132589270736146630382200675928609893),
    Elem::new(147757678647118321662818909505699287283),
    Elem::new(105191215649651969236839267469672730175),
    Elem::new(30602385955535098397645365408534849682),
    Elem::new(48325730328848992166772869048262435705),
    Elem::new(47107361695358134531081764995504982576),
    Elem::new(58217902130463319257742700532545131363),
    Elem::new(222131485577898385994296957605972419223),
    Elem::new(317366752970515991403658067120387116455),
    Elem::new(208889746421942579593670300885096411348),
    Elem::new(10500925112569452397974637113394588549),
    Elem::new(302579860472293984452437048601214483555),
    Elem::new(168041205275951341810398354660431653871),
    Elem::new(300717661816946641724887818523235842581),
    Elem::new(306373051518253857630596044145071396767),
    Elem::new(288522133472167381250123035924084341209),
    Elem::new(266083615972194573029045679368668373599),
    Elem::new(18080375153371618320981032818391993760),
    Elem::new(83450546038528342505410184895785916506),
    Elem::new(154615879374665237102406541751733142312),
    Elem::new(323008071020368954133994843172587655917),
    Elem::new(268385000807980881608335095869164839629),
    Elem::new(269152938220095088778774760980264777504),
    Elem::new(2904028602363498776232418586749171568),
    Elem::new(334107162622196219627169530268811447517),
    Elem::new(246714322959980349862405620259609552284),
    Elem::new(49587078644927305406817501447800792183),
    Elem::new(83112672766968435818926577516339392125),
    Elem::new(80067530517943140667265465666017907128),
    Elem::new(292099945386356264177400775412591329216),
    Elem::new(7048379784066566939194431853525473942),
    Elem::new(287819128805390954320237977587602149478),
    Elem::new(96084931109866088658506159957501440017),
    Elem::new(126020943552438761002937545585482711211),
    Elem::new(118038936085391799933500002132449644784),
    Elem::new(176199169566427658034185564004347234230),
    Elem::new(139009951604050089310013670227795097117),
    Elem::new(324315927297670800759887553582192860789),
    Elem::new(130126705490623885112781306696508927016),
    Elem::new(202089524762245668512971863102743308099),
    Elem::new(11857889273093507917377790145735753927),
    Elem::new(272693335888275500139349510826303226733),
    Elem::new(208925315136488397257522656849551583049),
    Elem::new(33415101301950447042333998557074303551),
    Elem::new(58146244484809263884667538634312125657),
    Elem::new(133586268171473729222738844566532328400),
    Elem::new(318019363942106888313812019750832403779),
    Elem::new(280112956634579182030527371112759441699),
    Elem::new(272116636043879456945430982796224226317),
    Elem::new(203577056054968069243953019431429997689),
    Elem::new(180310920550411827509317329166912190998),
    Elem::new(190936046183333967596139021224579843367),
    Elem::new(151402432653566414504403919565958154683),
    Elem::new(212861433844615851938527007263345335944),
    Elem::new(242879554823279199794778366573404102578),
    Elem::new(281753512956128418182042739024614978993),
    Elem::new(205071680323828730311148725793663426248),
    Elem::new(318506333834312974952373095822892921405),
    Elem::new(306960656916810811126664355938388783584),
    Elem::new(201961249109929433262714401937808902866),
    Elem::new(86587962373233483487788782881559528493),
    Elem::new(236678821873913600453776464398559727230),
    Elem::new(248479823662808519013629588339628722512),
    Elem::new(329162672624064647781582207180683984282),
    Elem::new(81180122484632563462902082684037422879),
    Elem::new(41902691070488399483482504798496528312),
    Elem::new(63546919026972325420682001419550340309),
    Elem::new(202951755447465293861110314690276911686),
    Elem::new(228049202032610127637368204871501342645),
    Elem::new(33964523817889612880696145942626788673),
    Elem::new(228806486799936455844699052346841684670),
    Elem::new(329607613118630255438188406296654848792),
    Elem::new(3308317620745711924657434480314773726),
    Elem::new(289492022635026308909933017129180403076),
    Elem::new(71746346927968589420146429091011677217),
    Elem::new(82389614376328046852093270450605153777),
    Elem::new(38571581709696004977923639294923225325),
    Elem::new(222851647003150646053207514727634987319),
    Elem::new(128872419965548821773563102245696620485),
    Elem::new(183496540018616505190221645070881276482),
    Elem::new(205234587191847464708296410146439147370),
    Elem::new(298933730558644367782307205439634111025),
    Elem::new(46934838641374228614739204367156541600),
    Elem::new(148068477531213384939772760839358656407),
    Elem::new(181930985418281174759183020889498453708),
    Elem::new(49319920100747174155147789895767981501),
    Elem::new(115202740632994407458529932974077558295),
    Elem::new(170223325256260620155643341538043938790),
    Elem::new(145398565342583747087631881239919989178),
    Elem::new(59327050215476007366120005258295920027),
    Elem::new(1036817405207659948716057874552868266),
    Elem::new(335510873914741239757292467851068470668),
    Elem::new(217975772849561948569408292289326390299),
    Elem::new(176867885740977911264125006771464857340),
    Elem::new(38453452917559664970098798439531006208),
    Elem::new(222207441009555434206639046897749530579),
    Elem::new(268851982489199762344260607353003112013),
    Elem::new(321695778210676751037308774873657615072),
    Elem::new(75635997588213287325214053317644046700),
    Elem::new(271546574112955615114343222167097826193),
    Elem::new(289645002905490505725672054785231928109),
    Elem::new(303642121596244434684219688057271614596),
    Elem::new(30964570000403248124438534893832192928),
    Elem::new(179334556405298120558511305443920101999),
    Elem::new(36493507425119274673995876666668423346),
    Elem::new(205493767261019686817163302844503294083),
    Elem::new(125466398946174130933263915966492842711),
    Elem::new(119475055276297705581728867017533118573),
    Elem::new(128861382348589881125457280889144109809),
    Elem::new(146931847795910830660722493608210717612),
    Elem::new(168046002751989014150230256065086496269),
    Elem::new(13243295302711903141502304087751838935),
    Elem::new(28581648163835961494835910049476137447),
    Elem::new(89480229086983577530168917943599908644),
    Elem::new(141565755927234887372415845399726192383),
    Elem::new(278690054979664382386627802413284477640),
    Elem::new(228011598899024874967637513154228691123),
    Elem::new(262359130743185915866401481074505431394),
    Elem::new(198977767133125848858520298158250755864),
    Elem::new(320746201140179019252602195197693073353),
    Elem::new(72165506060285779707022339376990605854),
    Elem::new(237182484432753383642116437124068567135),
    Elem::new(140671053036579655708235138134602411753),
    Elem::new(293742283644419432834971028489850288537),
    Elem::new(145593831311508765436386407791106099736),
    Elem::new(130627479751416532260193635658489423802),
    Elem::new(98926636582797524462434114964176191678),
    Elem::new(271872069564566099570104337575671611305),
    Elem::new(138101197701668918328362171659770492047),
    Elem::new(112137871375235469843953061466592562354),
    Elem::new(78393963201908542122181008295175172227),
    Elem::new(137839599162871849649967357883369144685),
    Elem::new(307638975120471156387791960890040323130),
    Elem::new(18587723142870355521083409744923567806),
    Elem::new(117108706231325815401917308854190991187),
    Elem::new(100923353906649407577674550523249165708),
    Elem::new(270506040383155244503157528645420476775),
    Elem::new(77682804757591629933413117280218764138),
    Elem::new(278058975304415606219264118066089978428),
    Elem::new(334503465275624821409951798384149426570),
    Elem::new(245813938213448495261241345370213447469),
    Elem::new(221551621152984544598834937422906646417),
    Elem::new(82501490347381674230331656279679347536),
    Elem::new(92006874115822343902880615312834319820),
    Elem::new(239536769432878189508226868328808778785),
    Elem::new(84827590788502362348038425560038481616),
    Elem::new(198304215319492277485491166700408760195),
    Elem::new(82101012700296258316462873442883067001),
    Elem::new(165984375247884336244807273478747935056),
    Elem::new(92892115376341577689761433843240279957),
    Elem::new(173103122334229261790810259827483287197),
    Elem::new(19871003727442610248506947674846193926),
    Elem::new(63013520890016474015816098011990501411),
    Elem::new(166418159415570699009021419308480360900),
    Elem::new(28018724018184826980966229942924613912),
    Elem::new(79411044810442545324406454925154103194),
    Elem::new(131886232228071557082497122881845378052),
    Elem::new(143642138152247487221557174359814747273),
    Elem::new(266300380935104576348416782216851620041),
    Elem::new(228985617105169702726277174383921577031),
    Elem::new(14101133257161116000881627171694497490),
    Elem::new(138372085628990498308837439261304658266),
    Elem::new(292483261037018564914673974996515703856),
    Elem::new(200065172757734424361353688372791748251),
    Elem::new(327914135990716647079290127440096128126),
    Elem::new(141630033968331728818121979694745222162),
    Elem::new(15570989311837177033123316735791317010),
    Elem::new(241595161718321072263270215816695498136),
    Elem::new(45563890341535504939343441002526772321),
    Elem::new(260300774691069579294958295118805746276),
];

const ROUND_CONSTANTS: [Elem; STATE_WIDTH * 2 * NUM_ROUNDS] = [
    Elem::new(312925064052272256435820216269854977511),
    Elem::new(286120806234983804880929805283814735619),
    Elem::new(265503088250046816228510591540420033407),
    Elem::new(231382209352150741468512272935036246686),
    Elem::new(31825582982959921582432887255945851873),
    Elem::new(207577723559333355971647176253126590953),
    Elem::new(309725441232551738748367994289314029788),
    Elem::new(94930906730408964660339944722679365589),
    Elem::new(192751704328452294593718683163817574249),
    Elem::new(291558992972059870773004808604133529013),
    Elem::new(301716401073008350542982792138661923115),
    Elem::new(209431247465646898846853219289459812227),
    Elem::new(210541915802567563901780205012006851465),
    Elem::new(206967822726148730611398677075572191989),
    Elem::new(305550660393098872593982871569503789713),
    Elem::new(203825150649174086457756850135014847576),
    Elem::new(66181854249405017076628835504041513324),
    Elem::new(325024993703299160047576217573069158071),
    Elem::new(80579247876115072168765339175306543270),
    Elem::new(47610876294132428589653844195182779002),
    Elem::new(255238043731162816432921915191930939422),
    Elem::new(49131841503317690727299232441548374779),
    Elem::new(933312895163672137587704983884082598),
    Elem::new(97146977017977370476714986268370153815),
    Elem::new(77710326861648200098701471351785961452),
    Elem::new(314459822084417206885362538476005642346),
    Elem::new(67840764836353635772207625670590977114),
    Elem::new(162940380382891603798158667842078131824),
    Elem::new(67401282554484002232479176646113594072),
    Elem::new(259385955254968866338223985238437350123),
    Elem::new(157044373522590290068595121329863400689),
    Elem::new(37078727467965733879111600121175015411),
    Elem::new(254492048083614463533568367172658892804),
    Elem::new(310897826881465534946785122570038014656),
    Elem::new(259259250911676003416061800218581286694),
    Elem::new(82194953524085522408673749988803375602),
    Elem::new(89798697429599827264371202043821935588),
    Elem::new(328068834193212650629140729784579256393),
    Elem::new(192153944957266160860270944495006190583),
    Elem::new(216364279615332711132618318123524985859),
    Elem::new(151423480831277846242428322740436686935),
    Elem::new(208094297621060813371243219999289984656),
    Elem::new(265774728676947634645478617689032814583),
    Elem::new(90079335026628551531353389645847064705),
    Elem::new(125336679639201921279990954074469527578),
    Elem::new(40445330994843811520924058004375164243),
    Elem::new(297833539337688141183742190547603968247),
    Elem::new(44758006425441291075942075447153815313),
    Elem::new(222511025871535486885383036583462061114),
    Elem::new(24727859205510865714836621248170546428),
    Elem::new(240823477207629618450168939693719568344),
    Elem::new(164024542610613817269475289316181558595),
    Elem::new(208780484881287634342816265741276976697),
    Elem::new(316053284372792350644929685467818345641),
    Elem::new(266856722126141767532664825423779878959),
    Elem::new(330444327368806877172716986299750759085),
    Elem::new(358556312115727846666879080745884456),
    Elem::new(89127008534706374850593013240570351583),
    Elem::new(113668099428953703334304155302377463535),
    Elem::new(319509938999435785004149529194274839026),
    Elem::new(179250407034454285383281111630962997),
    Elem::new(98443072826103888538684240578753643588),
    Elem::new(184901475038878064666523336408513582093),
    Elem::new(290641999684245708062238423301843776952),
    Elem::new(317449632344800587247575481023793964393),
    Elem::new(137641777839828808237541719475750316201),
    Elem::new(196129867840715960839394712331864716785),
    Elem::new(6688172092006504490695228765402574100),
    Elem::new(260216979883596870217591457541971180825),
    Elem::new(160578019840173657219624408107590972230),
    Elem::new(44701094974807792408457518992226784998),
    Elem::new(322058693706196450874876560059973974448),
    Elem::new(141457255565653599653459083376316760652),
    Elem::new(148322096110886598167354071058471065416),
    Elem::new(251466131635251660482831703418607005360),
    Elem::new(219062147624453164505004460576475485663),
    Elem::new(198439717802303154409779200011326182129),
    Elem::new(166458502500024526138525289571100260841),
    Elem::new(99009579434700718011495652714108345956),
    Elem::new(189954098812769040038728761669351113491),
    Elem::new(276529025817013977888287978787398038435),
    Elem::new(3431321439235119419341075137257713529),
    Elem::new(12136045129970348791596960595343856536),
    Elem::new(85542502085032808934765140492496674888),
    Elem::new(164463163042546178189071113779171259623),
    Elem::new(297289928919061970129951062816575191845),
    Elem::new(52116803264778669520837557451132380727),
    Elem::new(44877374455008440352132273770303076230),
    Elem::new(88887999599306329128425482281933911925),
    Elem::new(237890724283705315029632432154904549632),
    Elem::new(173331520753204336846039325919805907859),
    Elem::new(9727983086329440948643922659728020516),
    Elem::new(140330619170292811507976292812019774967),
    Elem::new(98686465846840277004124121670968379140),
    Elem::new(137911656091874725017184588695769309399),
    Elem::new(77485512255230368977894499412848465076),
    Elem::new(186807923964627698454815998864263168355),
    Elem::new(295118476414424488148508295442029091821),
    Elem::new(310791472091224953750607504957141043995),
    Elem::new(58880103983525348696410845078721898376),
    Elem::new(320198582116175218578038055306814106589),
    Elem::new(166674373913211269375146740714168079157),
    Elem::new(156337617342071604613078893967770742773),
    Elem::new(169331615701467610413072980986817937553),
    Elem::new(187692014116096595447584201459725101738),
    Elem::new(223688626941483639982392035939449734937),
    Elem::new(64588644523001992181858708038986845701),
    Elem::new(39125083391148736874419508296768207325),
    Elem::new(214167115883558272429674553320536939666),
    Elem::new(175697217820420518228744654912836829009),
    Elem::new(329958681471607102367964052378423877018),
    Elem::new(54369430343120026770327809838495395214),
    Elem::new(154189570377400087578591043202922851497),
    Elem::new(63845257481782427311284866160569745571),
    Elem::new(267406234742491772073493980749162636961),
    Elem::new(32225840376900205018058340931287136504),
    Elem::new(268344408233506818788617529449523004802),
    Elem::new(273789586028620907484746823246234035698),
    Elem::new(220987893142626077133842662696714890689),
    Elem::new(62900736872826200258969717157207039175),
    Elem::new(286907315608844249000687388669132045006),
    Elem::new(111342480966790000656807890701054611373),
    Elem::new(43261870427745740039180617308436493217),
    Elem::new(93246245387225076372270608507986845920),
    Elem::new(307172595622404939272464588393303101969),
    Elem::new(261090569350438065521822081090826867482),
    Elem::new(206135744029528624771407044463648613206),
    Elem::new(234855829267228066949508772504985610809),
    Elem::new(292370868747469480468997667635769326735),
    Elem::new(188682372299363604762011500769945127160),
    Elem::new(232021368922734985826176217683454978741),
    Elem::new(76927919712688000373781150731566202401),
    Elem::new(251421949558488042365284042118766370889),
    Elem::new(114825631823447454014435287670749747495),
    Elem::new(336637939710033133632674875859740528181),
    Elem::new(272978497629096636772543229812750179889),
    Elem::new(308273562135790478508613324934688353926),
    Elem::new(81076537719968876430591796650645698583),
    Elem::new(252885160152895753431561254383289247911),
    Elem::new(52669114393298853126606792608351291401),
    Elem::new(297125891470282200389021963679198199528),
    Elem::new(273789082503817493398744281780076358093),
    Elem::new(6833560980273939701072515626618557120),
    Elem::new(67976291352945908581297998863190322695),
    Elem::new(309380421612613565088401434037988294380),
    Elem::new(198159475241783210170226305410660765066),
    Elem::new(137790550525995469996905874179091588374),
    Elem::new(97141757994587663930573810555246972928),
    Elem::new(95081304704682698669498557931356866792),
    Elem::new(291794888882507544955876425913061127393),
    Elem::new(145340081185220410024777508656984882211),
    Elem::new(46085081658869994952573230440838000056),
    Elem::new(84868424892620444947311051512569188738),
    Elem::new(184107659812015657488356300453715669168),
    Elem::new(196238523735413594268212213057853230673),
    Elem::new(267788154532175309495532513860002753325),
    Elem::new(284108828113966162490460832003275328883),
    Elem::new(321792767254584929962262025157884756941),
    Elem::new(156262716145992743047243697411743086739),
    Elem::new(41993111058273245068628638173040949086),
    Elem::new(143673452011924858309629076435217173957),
    Elem::new(305043240511428106331727352653996583476),
    Elem::new(68145326892185223998012043011385619405),
    Elem::new(199961658234211447864101395427964376989),
    Elem::new(172891036562598739928452257738940531450),
    Elem::new(106854160828880679693635992498445943333),
    Elem::new(69054555585244286108664198354199124009),
    Elem::new(303130103002220471127990039860963312417),
    Elem::new(210370701760183597714499655795196219279),
    Elem::new(122165449834592726972376237864155566463),
    Elem::new(74697863568180319853036377034364868501),
    Elem::new(179053405482848029317247075803649889218),
    Elem::new(333061001786303525994580618844878146958),
    Elem::new(335257089895269616548640529862795381294),
    Elem::new(55631854636196146786004423079432007851),
    Elem::new(38622141702321694388434876060529678283),
    Elem::new(81009557470589385363740639753920882311),
    Elem::new(195524338569600607763649442925734609920),
    Elem::new(241966662122156331938440919677613264851),
    Elem::new(10954142707495165333976085822636718055),
    Elem::new(19636310243083774872007614313549917615),
    Elem::new(144587882680623518077922192172878510977),
    Elem::new(207553981918444181552133734505444847381),
    Elem::new(171619953569269686728747934922805663263),
    Elem::new(93501313698332062333828818893266296206),
    Elem::new(320481382570739878484770847743716718295),
    Elem::new(65207760935883530110250426698254326937),
    Elem::new(252600975114207564832148775001413059750),
    Elem::new(320427262268144231581539045499648079801),
    Elem::new(152703265506658959583333135557104098043),
    Elem::new(262189859253125062547620764668230152646),
    Elem::new(240650870796125030410630515967177841133),
    Elem::new(166897470511557112105627881796938972814),
    Elem::new(109566462155356633758038334012127683620),
    Elem::new(113691049079265377613056394412395250342),
    Elem::new(77538521224152402521117482985450988075),
    Elem::new(310087415785013406687728100644053532048),
    Elem::new(273183841007075173277022085767922530876),
    Elem::new(335486293154853812927037119074598409771),
    Elem::new(27767998265759851767472253798952521194),
    Elem::new(216164752920860056579869439861952331940),
    Elem::new(309718612678174356666511931349523973483),
    Elem::new(260312874451733715530998647932076353953),
    Elem::new(68087057934031510188258475258294083928),
    Elem::new(132307826810066216683608857814816837650),
    Elem::new(234955606095710495007588623677175335397),
    Elem::new(194382899660615981023735383996470844300),
    Elem::new(319039014320175587406577464153603059408),
    Elem::new(37237032190778211971866477263500475947),
    Elem::new(213779009645819314017008784762085407651),
    Elem::new(146144681134488044841411833641997800739),
    Elem::new(135484432047527048452828813442876988135),
    Elem::new(203306232782316920872175656736186918446),
    Elem::new(236457205578926330300251706475294391850),
    Elem::new(209702549926148859865790388653186486457),
    Elem::new(316972363928284520248168803518678449812),
    Elem::new(21698679449675848847409154509370623008),
    Elem::new(243283422123112595587185250494415234420),
    Elem::new(91150210215242670257506958513797440054),
    Elem::new(11418358443941398319016791819767291822),
    Elem::new(187202896325689762048433267402057944118),
    Elem::new(176834277490502177036515653020150559786),
    Elem::new(39045223447215258871933929509841544834),
    Elem::new(286406134746687178440647547197773884940),
    Elem::new(39499128932146921548674619416966032646),
    Elem::new(37784924957259286854500244969991577126),
    Elem::new(132840762559493299810229806810325146808),
    Elem::new(43170327206721821396451557269334367485),
    Elem::new(192679528115153552493251465898663076012),
    Elem::new(70636572961350995996661884995526119785),
    Elem::new(68735978361218010476132299991306957856),
    Elem::new(12158052128984473205758785198452526896),
    Elem::new(260002164035039990942133271110680818486),
    Elem::new(25710895091956115637382732697996937820),
    Elem::new(30180015986813722774385210043545255949),
    Elem::new(58354955485272826906748081769456226093),
    Elem::new(229552513467418091953693614181747070836),
    Elem::new(128004184592986299866983185640332704316),
    Elem::new(189275447035145849688411204677662391498),
    Elem::new(199999115957570158900973511341701009687),
    Elem::new(169359592549529528067658082577350077300),
    Elem::new(90615941666565506764896355728669578896),
    Elem::new(335391651559912565954318913298684467014),
    Elem::new(32404158566922002476831525838431514679),
    Elem::new(234098141250308153303831758836748193919),
    Elem::new(214702765828239423973539767989896192012),
    Elem::new(298714706431457014422375495248593112706),
    Elem::new(297030321017042198232281690986698102373),
    Elem::new(25221012416525698462545876477264932968),
    Elem::new(245712679198504301328095415781876325154),
    Elem::new(272162232654992681689706439807732476638),
    Elem::new(166654980961655441157489608960130531512),
    Elem::new(213032986562381329302651378146596016651),
    Elem::new(35501160877479357546879326370784993895),
    Elem::new(50230342841017968040528096907255767974),
    Elem::new(122591889629908463986730448899948949537),
    Elem::new(55868840632440926152960592062028950424),
    Elem::new(230801210829241993082809707293327200793),
    Elem::new(255446944104918800536588134988922836585),
    Elem::new(256612246145214500454577160339680518947),
    Elem::new(319931555690995119816151012013875258906),
    Elem::new(145824311390249158075458651872011907260),
    Elem::new(120412041830604937007301102592028187503),
    Elem::new(308574534006013021303967828202062542556),
    Elem::new(233028979750109343923804522773915049946),
    Elem::new(170881727949648882015475607791025357687),
    Elem::new(2439293753785687678911245900937615844),
    Elem::new(116740712311660665245384283794619944249),
    Elem::new(238261822860997769164175935577023057435),
    Elem::new(100585313143740974209029720135241280411),
    Elem::new(247906022835384438638361342058195210098),
    Elem::new(202664006735013338772516135535478902712),
];



pub fn hash(input_sequence: &Vec<Elem>) -> [Elem; RATE] {
    rescue_prime_hash(input_sequence)
}

// ALGORITHMS FROM https://eprint.iacr.org/2020/1143
// ================================================================================================

// Algorithm 1
pub fn rescue_prime_hash(input_sequence: &Vec<Elem>) -> [Elem; RATE] {
    assert_eq!(0, input_sequence.len() % RATE);
    let mut state = [Elem::ZERO; STATE_WIDTH];
    let mut absorb_index = 0;
    while absorb_index < input_sequence.len() {
        for i in 0..RATE {
            state[i] += input_sequence[absorb_index];
            absorb_index += 1;
        }
        rescue_xlix_permutation(&mut state);
    }
    let mut output_sequence = [Elem::ZERO; RATE];
    output_sequence.copy_from_slice(&state[..RATE]);
    output_sequence
}

// Algorithm 2
#[allow(dead_code)]
pub fn rescue_prime_wrapper(input_sequence: &Vec<Elem>) -> [Elem; RATE] {
    let mut padded_input = input_sequence.clone();
    padded_input.push(Elem::ONE);
    while (padded_input.len() % RATE) != 0 {
        padded_input.push(Elem::ZERO);
    }
    rescue_prime_hash(&padded_input)
}

// Algorithm 3
pub fn rescue_xlix_permutation(state: &mut [Elem; STATE_WIDTH]) {
    for round in 0..NUM_ROUNDS {
        let round_const = &ROUND_CONSTANTS[round * STATE_WIDTH * 2..(round + 1) * STATE_WIDTH * 2];
        apply_sbox(state);
        matrix_mul(MDS, state);
        add_constants(state, &round_const, 0);
        apply_inv_sbox(state);
        matrix_mul(MDS, state);
        add_constants(state, &round_const, STATE_WIDTH);
    }
}

// TRACE CONSTRUCTION
// ================================================================================================

pub fn apply_round(state: &mut [Elem], round: usize) {
    // determine which round constants to use
    let tmp_round = round % NUM_ROUNDS;
    let round_constants = &ROUND_CONSTANTS[tmp_round * STATE_WIDTH * 2..(tmp_round + 1) * STATE_WIDTH * 2];

    // apply first half of Rescue round
    apply_sbox(state);
    matrix_mul(MDS, state);
    add_constants(state, &round_constants, 0);

    // apply second half of Rescue round
    apply_inv_sbox(state);
    matrix_mul(MDS, state);
    add_constants(state, &round_constants, STATE_WIDTH);
}

// TRANSITION CONSTRAINTS
// ================================================================================================

/// when flag = 1, enforces constraints for a single round of Rescue hash functions
pub fn enforce_round<E: FieldElement + From<Elem>>(
    result_slice: &mut [E],
    current_slice: &[E],
    next_slice: &[E],
    round_constants: &[E],
    flag: E,
) {
    // compute the state that should result from applying the first half of Rescue round
    // to the current state of the computation
    let mut step1 = [E::ZERO; STATE_WIDTH];
    step1.copy_from_slice(current_slice);
    apply_sbox(&mut step1);
    matrix_mul(MDS, &mut step1);
    for i in 0..STATE_WIDTH {
        step1[i] += round_constants[i];
    }

    // compute the state that should result from applying the inverse for the second
    // half for Rescue round to the next step of the computation
    let mut step2 = [E::ZERO; STATE_WIDTH];
    step2.copy_from_slice(next_slice);
    for i in 0..STATE_WIDTH {
        step2[i] -= round_constants[STATE_WIDTH + i];
    }
    matrix_mul(INV_MDS, &mut step2);
    apply_sbox(&mut step2);

    // make sure that the results are equal
    for i in 0..STATE_WIDTH {
        result_slice[i] += flag * (step2[i] - step1[i]);
    }
}

// ROUND CONSTANTS
// ================================================================================================

/// when flag = 1, enforces constraints for a single round of Rescue hash functions
pub fn enforce_first_round<E: FieldElement + From<Elem>>(
    result_slice: &mut [E],
    pixels: &[E],
    current_slice: &[E],
    next_slice: &[E],
    round_constants: &[E],
    flag: E,
) {
    // compute the state that should result from applying the first half of Rescue round
    // to the current state of the computation
    let mut step1 = [E::ZERO; STATE_WIDTH];
    step1.copy_from_slice(current_slice);
    for i in 0..RATE {
        step1[i] += pixels[i];
    }
    apply_sbox(&mut step1);
    matrix_mul(MDS, &mut step1);
    for i in 0..STATE_WIDTH {
        step1[i] += round_constants[i];
    }

    // compute the state that should result from applying the inverse for the second
    // half for Rescue round to the next step of the computation
    let mut step2 = [E::ZERO; STATE_WIDTH];
    step2.copy_from_slice(next_slice);
    for i in 0..STATE_WIDTH {
        step2[i] -= round_constants[STATE_WIDTH + i];
    }
    matrix_mul(INV_MDS, &mut step2);
    apply_sbox(&mut step2);

    // make sure that the results are equal
    for i in 0..STATE_WIDTH {
        result_slice[i] += flag * (step2[i] - step1[i]);
    }
}

/// returns round constants arranged in column-major form for periodic columns
pub fn get_round_constants_periodic(cycle_length: usize, shift: usize) -> Vec<Vec<Elem>> {
    let mut constants = Vec::new();
    for _ in 0..(STATE_WIDTH * 2) {
        constants.push(vec![Elem::ZERO; cycle_length]);
    }
    for i in 0..NUM_ROUNDS {
        for j in 0..(STATE_WIDTH * 2) {
            constants[j][(i + shift) % cycle_length] = ROUND_CONSTANTS[i * STATE_WIDTH * 2 + j];
        }
    }
    constants
}

// HELPER FUNCTIONS
// ================================================================================================

fn add_constants(state: &mut [Elem], round_constants: &[Elem], offset: usize) {
    for i in 0..STATE_WIDTH {
        state[i] += round_constants[offset + i];
    }
}

fn apply_sbox<E: FieldElement>(state: &mut [E]) {
    for i in 0..STATE_WIDTH {
        state[i] = state[i].exp(ALPHA.into());
    }
}

fn apply_inv_sbox(state: &mut [Elem]) {
    for i in 0..STATE_WIDTH {
        state[i] = state[i].exp(INV_ALPHA);
    }
}

fn matrix_mul<E: FieldElement + From<Elem>>(matrix: [Elem; STATE_WIDTH * STATE_WIDTH], state: &mut [E]) {
    let mut result = [E::ZERO; STATE_WIDTH];
    for row in 0..STATE_WIDTH {
        for col in 0..STATE_WIDTH {
            result[row] += E::from(matrix[row * STATE_WIDTH + col]) * state[col];
        }
    }
    state.copy_from_slice(&result);
}
